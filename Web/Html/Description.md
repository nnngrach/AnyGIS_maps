| [AnyGIS][01] | [Как это работает?][02] | [RusOutdoor Maps][03] | [Карты для Locus][04] | [Карты для GuruMaps][05] | [API][06] |


[01]: https://nnngrach.github.io/map-sources/index
[02]: https://nnngrach.github.io/map-sources/Web/Html/Description
[03]: https://nnngrach.github.io/map-sources/Web/Html/RusOutdoor
[04]: https://nnngrach.github.io/map-sources/Web/Html/Locus
[05]: https://nnngrach.github.io/map-sources/Web/Html/Galileo
[06]: https://nnngrach.github.io/map-sources/Web/Html/Api



# Как это работает?

![](https://nnngrach.github.io/map-sources/Web/Img/Tiles.png)

### Поговорим о мобильных навигаторах

Чтобы приложения для навигации могли на лету подгружать из интернета нужные участки карты нужно хранить файлы карты особым образом. Карту разделяют на небольшие кусочки (обычно, это изображения формата PNG размера 256x256 px) и хранят их на специальных серверах. При этом, названия этих файлов (и папок, которых они лежат) обычно являются числами - координатами, которым соответствует то или иное изображение. Например, это может выглядеть так: 

```
www.funmap.com / 10 / 200 / 115.png
```


Генерация подобного адреса навигационных приложениях происходит в два шага:

1 - Навигатор загружает тектовый файл с "заготовкой" адреса.

```
www.funmap.com / Z / X / Y.png
```

2 - Навигатор подставляет на место букв XYZ координаты кусочка карты, который нужно отобразить на экране. 

```
www.funmap.com / 10 / 200 / 115.png
```



Обычно, чтобы подключить любую другую карту достаточно создать еще один файл-заготовку с новым адресом и буквами XYZ на требуемых местах.

```
www.Another-map.org/satellite / X / Y / Z.png
```

И в большинстве случаев, навигатор без проблем заменит XYZ на требуемые числа и карта будет загружаться. Большинство сайтов с дополнительными источниками карт для того или иного навигатора именно такие файлики и предлагают.

Увы, но бывают исключения в виде "сложных" карт. К примеру, на некоторых серверах для нумерации файлов может использоваться другая система координат. И чтобы загруженный кусок карты соответствовал требуемому месту, числа XYZ нужно прогнать через ряд математических преобразований. (обозначу их, как XYZ во второй проекции)

```
www.funmap.com / X2 / Y2 / Z2.png
```

А на некоторых серверах в адресах используются дополнительные числа. Например, все файлы могут быть разделены на подпапки по 1000 файлов в каждой. Тогда надо будет вычислить эти два дополнительные числа.

```
www.funmap.com / Folder_1 / X / Folder_2 / Y / Z.png
```

К сожалению, навигационные приложения не могут выполнять многие из этих дополнительных вычислений. А значит, чтобы не ограничивать себя в выборе карт, которые можно подключить к своему навигатору, потребуется дополнительная утилита, которая выполнит все те задачи, с которыми не сможет справится мобильный навигатор.



### Промежуточное звено

Как уже говорилось, AnyGIS - это серверное приложение. В тех случаях, когда не удается подключить навигатор к какому-либо источнику карт напрямую...

```
Навигатор   ->   funmap.com/ X2 / Y2 / Z2 
```

... можно сделать это через дополнительное звено: через AnyGIS.

```
Навигатор   ->   anygis.com/ funmap / X1 / Y1 / Z1   ->   funmap.com/ X2 / Y2 / Z2 
```

Навигатор может обращаться к AnyGIS со стандартными XYZ. AnyGIS проведет все необходимые преобразования и сформирует нужный URL-адрес. Затем он скачает с него файл с кусочком карты и отошлет этот файл обратно на навигатор (или же просто сделает редирект). В результате, на смартфоне будет отображаться карта, подключиться к которой ранее не представлялось возможным.


Помимо этого, благодаря сервису [Cloudinary][1], AnyGIS может осуществлять обработку изображений на лету. Например, он может скачать несколько слоев для многослойных карт, "склеить" их в одно изображение и отослать его на навигатор. Такая функция может пригодиться для навигаторов, которые не умеют самостоятельно работать со слоями. 



### Круглая или не очень? 

Кроме того, AnyGIS умеет делать несложные [преобразования][2] карт в разных проекциях. А точнее, пока только одно: сделать подгонку карт из проекции WGS84 (Яндекс карты, Космоснимки) в стандартную проекцию Web Mercator.  Это позволит подключить Яндекс карты к навигаторам, которые не могут сами осуществить подобные преобразования. Например к Guru Maps.

Стоит заметить, что в целях ускорения быстродействия эта подгонка происходит по упрощенной схеме. А именно, с помощью обычного смещения карты. Технически, это происходит следующим образом. Допустим, требуется получить кусок карты для этого места. (На изображении - эталон - кусок карты в стандартной проекции).

<center>

text 1

![](https://nnngrach.github.io/map-sources/Web/Img/osm.jpg)

</center>

<p align="center">
<img src="./Web/Img/osm.png"/>
</p>


Для начала, вычисляются координаты четырех ближайших к требуемому месту кусочков WGS84 карты. Все четыре кусочка загружаются и "склеиваются" в один большой квадрат.

![](https://nnngrach.github.io/map-sources/Web/Img/wgs4.jpg)

Вычисляется, на какое расстояние требуется "cместить" новую карту. На большом квадрате делаются соответствующие отступы и вырезается кусок стандартного размера. 

![](https://nnngrach.github.io/map-sources/Web/Img/wgs_offset.jpg)

Получаем довольно похожий кусочек карты на то, что требуется. В принципе, для большинства задач такой грубой подгонки будет вполне достаточно. Однако стоит отметить, что небольшие расхождения все-таки будут присутствовать. Особенно они будут заметны ближе к полюсам.

![](https://nnngrach.github.io/map-sources/Web/Img/wgs_osm.jpg)

Кроме того, на то, чтобы "отфотошопить" карту на лету, потребуется некоторое время. То есть, карта с подобными преобразованиями будет загружаться не столь быстро, как остальные карты без каких-либо обработок. 


### Вырезать лучшее и собрать вместе

Ну, и последний режим, в котором может работать AnyGIS - это поиск наилучшего варианта карты для данной местности. Особенно это будет актуально для растровых (грубо говоря, отсканированных) карт, которые покрывают не всю планету, а только какой-нибудь небольшой кусок местности. 

Для этого формируется список карт, отсортированных в порядке их приоритета. Сначала AnyGIS проверяет первую карту: есть ли на сервере с ней файл с интересующим нас кусочком местности. Если нет, то проверяется вторая карта и так далее по списку. 

![](https://nnngrach.github.io/map-sources/Web/Img/slazav.png)

Подобный режим позволяет склеить мелкие разрозненные кусочки с разных серверов в цельную неразрывную карту, которой сравнительно удобно пользоваться. Не требуется вручную переключаться между десятком различных карт, пока не отыщется хотя бы одна, которая будет пригодна для этой местности.

В качестве примера подобной карты вы можете ознакомиться с набором карт для туризма по России - [RusOutdoor Maps][03].

[1]: https://cloudinary.com/
[2]: https://habr.com/ru/post/151103/
